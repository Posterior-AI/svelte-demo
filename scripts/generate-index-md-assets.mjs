import fs from 'node:fs';
import path from 'node:path';
import TurndownService from 'turndown';

const OUTPUT_ROOT = path.resolve('.svelte-kit/cloudflare');
const BASE_URL = process.env.BYOB_BASE_URL || 'https://byob.page';

const turndown = new TurndownService({
	headingStyle: 'atx',
	codeBlockStyle: 'fenced'
});

turndown.keep(['table']);

function extractTagContent(html, tag) {
	const match = html.match(new RegExp(`<${tag}[^>]*>([\\s\\S]*?)</${tag}>`, 'i'));
	return match ? match[1].trim() : '';
}

function extractMetaContent(html, name) {
	const match = html.match(
		new RegExp(`<meta[^>]+name=["']${name}["'][^>]*content=["']([^"']*)["'][^>]*>`, 'i')
	);
	return match ? match[1].trim() : '';
}

function extractMainHtml(html) {
	const mainMatch = html.match(/<main[^>]*>([\s\S]*?)<\/main>/i);
	if (mainMatch) return mainMatch[1];
	const bodyMatch = html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
	if (bodyMatch) return bodyMatch[1];
	return html;
}

function stripNonContent(html) {
	return html
		.replace(/<script[\s\S]*?<\/script>/gi, '')
		.replace(/<style[\s\S]*?<\/style>/gi, '')
		.replace(/<link[\s\S]*?>/gi, '')
		.replace(/<noscript[\s\S]*?<\/noscript>/gi, '');
}

function yamlString(value) {
	const sanitized = value.replace(/\r?\n/g, ' ').trim();
	return JSON.stringify(sanitized);
}

function toTitleFromPath(pathname) {
	if (pathname === '/') return 'Home';
	const segment = pathname.replace(/\/$/, '').split('/').pop() || 'Home';
	return segment.replace(/[-_]+/g, ' ').replace(/\b\w/g, (char) => char.toUpperCase());
}

function routeFromHtmlPath(rootDir, filePath) {
	const rel = path.relative(rootDir, filePath).replace(/\\/g, '/');
	if (rel === 'index.html') return '/';
	if (rel.endsWith('/index.html')) return `/${rel.replace(/\/index\.html$/, '')}`;
	return `/${rel.replace(/\.html$/, '')}`;
}

function mdPathFromHtmlPath(rootDir, filePath) {
	const rel = path.relative(rootDir, filePath).replace(/\\/g, '/');
	if (rel === 'index.html') return 'index.md';
	if (rel.endsWith('/index.html')) return rel.replace(/\/index\.html$/, '/index.md');
	return rel.replace(/\.html$/, '/index.md');
}

function getFrontmatter(html, routePath) {
	const title = extractTagContent(html, 'title') || toTitleFromPath(routePath);
	const description = extractMetaContent(html, 'description');
	const lastUpdated = new Date().toISOString();
	const canonicalPath = routePath === '/' ? '/' : `${routePath.replace(/\/$/, '')}/`;

	return [
		'---',
		`title: ${yamlString(title)}`,
		`description: ${yamlString(description)}`,
		`lastUpdated: ${lastUpdated}`,
		'builtWith: byob.studio',
		'llmsTxt: autogenerated by byob.studio',
		'chatbotDeprioritize: false',
		'source_url:',
		`  html: ${BASE_URL}${canonicalPath}`,
		`  md: ${BASE_URL}${canonicalPath}index.md`,
		'---',
		''
	].join('\n');
}

function walkHtmlFiles(dir, files = []) {
	if (!fs.existsSync(dir)) return files;
	for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
		const fullPath = path.join(dir, entry.name);
		if (entry.isDirectory()) {
			walkHtmlFiles(fullPath, files);
		} else if (entry.isFile() && entry.name.endsWith('.html')) {
			files.push(fullPath);
		}
	}
	return files;
}

function generateIndexMdFromHtml(rootDir) {
	const htmlFiles = walkHtmlFiles(rootDir);
	for (const htmlFile of htmlFiles) {
		const html = fs.readFileSync(htmlFile, 'utf-8');
		const routePath = routeFromHtmlPath(rootDir, htmlFile);
		const contentHtml = stripNonContent(extractMainHtml(html));
		const markdownBody = turndown.turndown(contentHtml).trim();
		const frontmatter = getFrontmatter(html, routePath);

		const relMd = mdPathFromHtmlPath(rootDir, htmlFile);
		const mdFile = path.join(rootDir, relMd);
		fs.mkdirSync(path.dirname(mdFile), { recursive: true });
		fs.writeFileSync(mdFile, `${frontmatter}${markdownBody}\n`);
	}
	return htmlFiles.length;
}

if (!fs.existsSync(OUTPUT_ROOT)) {
	console.log('⚠️ [byob] Cloudflare output not found, run build first.');
	process.exit(0);
}

const total = generateIndexMdFromHtml(OUTPUT_ROOT);
console.log(`✅ [byob] Generated index.md files for ${total} HTML pages in cloudflare output.`);
